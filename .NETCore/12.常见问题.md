# 常见问题

####  1. EFCore 

+ 问题:

```
The instance of entity type 'XXX' cannot be tracked because another instance with the same key value for {'Id'} is already being tracked. When attaching existing entities, ensure that only one entity instance with a given key value is attached. Consider using 'DbContextOptionsBuilder.EnableSensitiveDataLogging' to see the conflicting key values
```
   + 问题原因:

     > 查询跟insert/update等操作在一起, 导致实体对象被追踪, 无法进行下一步操作

   + 解决方法: 

     > way1: 在查询的时候取消追踪 - **disableTracking:false**

     ```c#
     repo.GetFirstOrDefault(predicate: 条件,新增: disableTracking:false);
     ```

     > way2: 在查询完成并对查询结果进行了修改之后, 直接SaveChanges()

#### 2. StartUp中

+ 问题:

```
System.AggregateException
  HResult=0x80131500
  Message=Some services are not able to be constructed (Error while validating the service descriptor 'ServiceType: Swashbuckle.AspNetCore.Swagger.ISwaggerProvider Lifetime: Transient ImplementationType: Swashbuckle.AspNetCore.SwaggerGen.SwaggerGenerator': Unable to resolve service for type 'Microsoft.AspNetCore.Mvc.ApiExplorer.IApiDescriptionGroupCollectionProvider' while attempting to activate 'Swashbuckle.AspNetCore.SwaggerGen.SwaggerGenerator'.) (Error while validating the service descriptor 'ServiceType: Microsoft.Extensions.ApiDescriptions.IDocumentProvider Lifetime: Singleton ImplementationType: Microsoft.Extensions.ApiDescriptions.DocumentProvider': Unable to resolve service for type 'Microsoft.AspNetCore.Mvc.ApiExplorer.IApiDescriptionGroupCollectionProvider' while attempting to activate 'Swashbuckle.AspNetCore.SwaggerGen.SwaggerGenerator'.)
  Source=Microsoft.Extensions.DependencyInjection
  StackTrace:
   at Microsoft.Extensions.DependencyInjection.ServiceProvider..ctor(IEnumerable`1 serviceDescriptors, ServiceProviderOptions options)
   at Microsoft.Extensions.DependencyInjection.ServiceCollectionContainerBuilderExtensions.BuildServiceProvider(IServiceCollection services, ServiceProviderOptions options)
   at Microsoft.Extensions.DependencyInjection.DefaultServiceProviderFactory.CreateServiceProvider(IServiceCollection containerBuilder)
   at Microsoft.Extensions.Hosting.Internal.ServiceFactoryAdapter`1.CreateServiceProvider(Object containerBuilder)
   at Microsoft.Extensions.Hosting.HostBuilder.CreateServiceProvider()
   at Microsoft.Extensions.Hosting.HostBuilder.Build()
   at AutoMapperSampler.Program.Main(String[] args) in D:\CustouchProject\sample\gRPCSample\AutoMapperSampler\Program.cs:line 16

  此异常最初是在此调用堆栈中引发的: 
    Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.CreateArgumentCallSites(System.Type, System.Type, Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteChain, System.Reflection.ParameterInfo[], bool)
    Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.CreateConstructorCallSite(Microsoft.Extensions.DependencyInjection.ServiceLookup.ResultCache, System.Type, System.Type, Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteChain)
    Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.TryCreateExact(Microsoft.Extensions.DependencyInjection.ServiceDescriptor, System.Type, Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteChain, int)
    Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.GetCallSite(Microsoft.Extensions.DependencyInjection.ServiceDescriptor, Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteChain)
    Microsoft.Extensions.DependencyInjection.ServiceLookup.ServiceProviderEngine.ValidateService(Microsoft.Extensions.DependencyInjection.ServiceDescriptor)

内部异常 1:
InvalidOperationException: Error while validating the service descriptor 'ServiceType: Swashbuckle.AspNetCore.Swagger.ISwaggerProvider Lifetime: Transient ImplementationType: Swashbuckle.AspNetCore.SwaggerGen.SwaggerGenerator': Unable to resolve service for type 'Microsoft.AspNetCore.Mvc.ApiExplorer.IApiDescriptionGroupCollectionProvider' while attempting to activate 'Swashbuckle.AspNetCore.SwaggerGen.SwaggerGenerator'.

内部异常 2:
InvalidOperationException: Unable to resolve service for type 'Microsoft.AspNetCore.Mvc.ApiExplorer.IApiDescriptionGroupCollectionProvider' while attempting to activate 'Swashbuckle.AspNetCore.SwaggerGen.SwaggerGenerator'.

```
+ 问题原因:

> ConfigureService中没有注入Controllers

+ 解决方法:

> services.AddControllers();

#### 3. 服务启动时

+ 问题:

```
"System.InvalidOperationException: 'A path base can only be configured using IApplicationBuilder.UsePathBase().'"
```

+ 问题原因:

在launchSetting.json中设置了applicationUrl, 导致该问题的出现:
> "applicationUrl": "https://localhost:5001/swagger"

+ 解决方法:

修改回根url,并添加一个launchUrl, 以修改启动所需的路径:

>"applicationUrl": "https://localhost:5001",
>"launchUrl": "swagger"

### 4. Microsoft.EntityFrameworkCore.UnitOfWork

- 问题:

```
System.InvalidOperationException: A TransactionScope must be disposed on the same thread that it was created. 
```

+ 问题原因:

详见源码的一个issue:

> [Fix InvalidOperationException on SaveChangesAsync and transaction scope by djechelon · Pull Request #148 · Arch/UnitOfWork (github.com)](https://github.com/Arch/UnitOfWork/pull/148)

+ 解决方法:

> Microsoft.EntityFrameworkCore.UnitOfWork版本
>
> 1. 3.1.0及以前, 即[NuGet Gallery | Microsoft.EntityFrameworkCore.UnitOfWork 3.1.0](https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.UnitOfWork/3.1.0)中2019/12/13及以前的版本都有这个问题, **建议不使用方法SaveChangesAsync(),而使用SaveChanges()**